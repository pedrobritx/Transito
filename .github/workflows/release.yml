name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  build-and-release-macos:
    name: Build and release macOS app
    runs-on: macos-latest
    permissions:
      contents: write

    env:
      APP_BUNDLE_ID: com.transito.hls-downloader
      APP_NAME: Transito
      OUTPUT_DIR: ${{ github.workspace }}/out

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare output directory
        run: mkdir -p "$OUTPUT_DIR"

      - name: Build SwiftUI macOS app (xcodebuild)
        run: |
          set -e
          xcodebuild -project packages/macos/Transito/Transito.xcodeproj \
            -scheme Transito -configuration Release \
            -derivedDataPath build/derived

          # Package .app as zip
          APP_PATH="build/derived/Build/Products/Release/Transito.app"
          if [ -d "$APP_PATH" ]; then
            ditto -c -k --sequesterRsrc --keepParent "$APP_PATH" "$OUTPUT_DIR/Transito.app.zip"
            shasum -a 256 "$OUTPUT_DIR/Transito.app.zip" > "$OUTPUT_DIR/Transito.app.zip.sha256"
          else
            echo "Warning: App bundle not found at $APP_PATH"
            exit 1
          fi

      - name: Codesign and Notarize (macOS)
        # Disabled by default. Enable by setting to true and provide the required secrets.
        if: false
        run: |
          echo "Codesign and notarize step is disabled. To enable, provide required secrets (APPLE_ID, APP_SPECIFIC_PASSWORD, P12_BASE64, P12_PASSWORD)."

      - name: Extract release notes from CHANGELOG.md
        id: extract_notes
        env:
          TAG_NAME: ${{ github.ref_name }}
        run: |
          set -e
          VER="${TAG_NAME#v}"
          OUT=out/release_notes.md
          awk -v ver="$VER" '
            $0 ~ "^## \["ver"\]" {print; flag=1; next}
            /^## \[/ && flag {exit}
            flag {print}
          ' CHANGELOG.md > "$OUT" || true
          if [ ! -s "$OUT" ]; then
            echo "ERROR: No changelog section for $VER found in CHANGELOG.md" >&2
            exit 1
          fi
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          cat "$OUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          body: ${{ steps.extract_notes.outputs.notes }}
          files: |
            ${{ env.OUTPUT_DIR }}/Transito.app.zip
            ${{ env.OUTPUT_DIR }}/Transito.app.zip.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
